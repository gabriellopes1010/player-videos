<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAaXWAAACV/wCMAP8AFBcaAAD/qgAnLDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEEAAAAAAAAAAAAAAQBAAEGAAAAAAAAAAAAAAAABgEEAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAABQUAAAACAgIAAAMDAAAABQAABQACAAAAAAADAwAAAAUAAAUAAgICAgADAAADAAAFAAAFAAIAAAIAAwAAAwAAAAUFBQAAAgIAAAMAAAMAAAAAAAUAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAQBBgAAAAAAAAAAAAAAAAYBAAEEAAAAAAAAAAAAAAQBAIABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAAA="
      rel="icon"
      type="image/x-icon"
    />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <title>Full Cycle 3.0</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body id="body">
    <!-- Botão para alternar tema -->
    <div class="content">
      <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <h1>Full Cycle 3.0</h1>
          <div class="search-container">
            <input
              type="text"
              placeholder="Pesquisar..."
              id="search-input"
              onkeyup="searchContent()"
            />
          </div>
          <h2 class="text-white">Seções Disponíveis</h2>
          <div id="video-menu"></div>
        </div>

        <!-- Conteúdo -->
        <div class="flex-1 p-6">
          <div class="top-bar flex justify-between items-center">
            <!-- Botão Alternar Tema (Centralizado) -->
            <div class="flex-1 text-center">
              <button
                id="toggle-theme"
                class="px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-700"
              >
                Alternar Tema
              </button>
            </div>

            <!-- Controles de tamanho da fonte (Alinhados à direita) -->
            <div class="font-size-controls flex space-x-2">
              <button
                id="decrease-font-size"
                class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-700"
              >
                A-
              </button>
              <button
                id="increase-font-size"
                class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-700"
              >
                A+
              </button>
            </div>
          </div>
          <!-- Breadcrumbs -->
          <div id="breadcrumbs" class="mb-4 font-semibold"></div>

          <!-- Navegação de vídeos -->
          <div class="flex justify-between items-center mb-4">
            <button
              id="prev-button"
              class="px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-700"
            >
              Anterior
            </button>
            <h3 id="video-title" class="text-xl font-semibold">
              Selecione um vídeo
            </h3>
            <button
              id="next-button"
              class="px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-700"
            >
              Próximo
            </button>
          </div>

          <div class="video-container" id="video-container">
            <video id="video-player" controls>
              Seu navegador não suporta vídeos.
            </video>
            <div
              id="text-content"
              class="hidden mt-4 w-full p-2 bg-gray-100 rounded"
            ></div>
            <textarea
              id="user-notes"
              class="mt-4 w-full p-2"
              placeholder="Digite suas notas aqui..."
            ></textarea>
            <button
              id="save-notes"
              class="mt-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-700"
            >
              Salvar Notas
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para download de arquivos -->
    <div
      id="download-modal"
      class="hidden inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 id="modal-title" class="text-xl font-semibold mb-4">
          Download de Arquivo
        </h2>
        <p id="modal-description" class="mb-4">
          Clique no botão abaixo para baixar o arquivo.
        </p>
        <a
          id="download-link"
          href="#"
          id="download-link"
          class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-700"
          >Download</a
        >
        <button
          id="close-modal"
          class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-700"
        >
          Fechar
        </button>
      </div>
    </div>

    <script>
      // Alternar entre modo claro e escuro
      // Adicione essas variáveis para controlar a navegação
      let currentModule = "";
      let currentSection = "";
      let currentVideoIndex = 0;
      let videoList = [];
      // Atualize a função loadVideo para armazenar as informações de navegação

      function navigateContent(direction) {
        if (direction === 1 && currentVideoIndex < videoList.length - 1) {
          // Próximo vídeo
          loadVideo(
            currentModule,
            currentSection,
            videoList[currentVideoIndex + 1]
          );
        } else if (direction === -1 && currentVideoIndex > 0) {
          // Vídeo anterior
          loadVideo(
            currentModule,
            currentSection,
            videoList[currentVideoIndex - 1]
          );
        } else if (
          direction === 1 &&
          currentVideoIndex >= videoList.length - 1
        ) {
          // Próxima seção
          goToNextSection();
        }
      }

      // Adicione os eventos de clique dos botões "Anterior" e "Próximo"
      document.addEventListener("DOMContentLoaded", function () {
        // Certifique-se de que o modal esteja oculto no carregamento da página
        document.getElementById("download-modal").classList.add("hidden");
      });

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
          "darkMode",
          document.body.classList.contains("dark-mode")
        );
      }
      document
        .getElementById("toggle-theme")
        .addEventListener("click", toggleDarkMode);
      // Definir o tema no carregamento
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
      }

      function searchContent() {
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();
        const modules = document.querySelectorAll("#video-menu .module");

        modules.forEach((module) => {
          const sections = module.querySelectorAll(".section");
          let moduleMatches = false; // Controla se algum vídeo ou seção corresponde ao termo

          sections.forEach((section) => {
            const videoLinks = section.querySelectorAll("a");
            let sectionMatches = false; // Controla se alguma aula na seção corresponde ao termo

            videoLinks.forEach((videoLink) => {
              const videoTitle = videoLink.textContent.toLowerCase();

              if (videoTitle.includes(searchTerm)) {
                videoLink.style.display = "block"; // Exibe o vídeo correspondente
                sectionMatches = true;
              } else {
                videoLink.style.display = "none"; // Oculta o vídeo que não corresponde
              }
            });

            // Se alguma aula na seção corresponde ao termo, a seção será exibida
            section.style.display = sectionMatches ? "block" : "none";

            // Se alguma seção corresponde, o módulo será exibido
            if (sectionMatches) {
              moduleMatches = true;
            }
          });

          // Se algum item no módulo ou suas seções corresponder, exibe o módulo
          module.style.display = moduleMatches ? "block" : "none";
        });
      }
      let data = {};
      // Carregar o menu de vídeos dinamicamente
      async function loadVideos() {
        const response = await fetch("/files");
        data = await response.json();
        const menu = document.getElementById("video-menu");
        menu.innerHTML = ""; // Limpa o conteúdo anterior

        Object.keys(data).forEach((module) => {
          let moduleDiv = document.createElement("div");
          moduleDiv.classList.add(
            "module",
            "border-b",
            "p-2",
            "cursor-pointer",
            "text-lg",
            "font-semibold",
            "text-white",
            "bg-gray-800",
            "rounded-md",
            "hover:bg-gray-700"
          );

          moduleDiv.innerHTML = `<span>${module}</span>`;

          let sectionDiv = document.createElement("div");
          sectionDiv.classList.add("ml-4", "hidden", "space-y-2");

          Object.keys(data[module]).forEach((section) => {
            let sectionItem = document.createElement("div");
            sectionItem.classList.add(
              "section",
              "p-2",
              "cursor-pointer",
              "text-sm",
              "text-blue-400",
              "border-l-4",
              "border-blue-500",
              "hover:bg-gray-700",
              "rounded-md"
            );

            sectionItem.innerHTML = `<span>${section}</span>`;

            let videoList = document.createElement("div");
            videoList.classList.add("ml-4", "hidden", "space-y-1");

            data[module][section].forEach((video) => {
              let videoLink = document.createElement("a");
              videoLink.href = "#";
              videoLink.innerText = video;
              videoLink.classList.add(
                "block",
                "p-1",
                "text-gray-300",
                "hover:text-white",
                "text-sm"
              );

              videoLink.addEventListener("click", (event) => {
                event.stopPropagation(); // Prevent collapsing when clicking on a video
                loadVideo(module, section, video); // Call the function to load the selected video
              });

              videoList.appendChild(videoLink);
            });

            sectionItem.addEventListener("click", (event) => {
              event.stopPropagation(); // Prevent collapsing when clicking on a section
              videoList.classList.toggle("hidden");
            });

            sectionItem.appendChild(videoList);
            sectionDiv.appendChild(sectionItem);
          });

          moduleDiv.addEventListener("click", (event) => {
            event.stopPropagation(); // Prevent collapsing when clicking on a module
            sectionDiv.classList.toggle("hidden");
          });

          moduleDiv.appendChild(sectionDiv);
          menu.appendChild(moduleDiv);
        });
      }

      // Carregar o vídeo selecionado
      async function loadVideo(module, section, video) {
        let videoPlayer = document.getElementById("video-player");
        let textContent = document.getElementById("text-content");
        const encodedModule = encodeURIComponent(module);
        const encodedSection = encodeURIComponent(section);
        const encodedVideo = encodeURIComponent(video);

        // Atualizando variáveis globais
        currentModule = module;
        currentSection = section;
        videoList = Object.values(data[module][section]);
        currentVideoIndex = videoList.indexOf(video);

        console.log(`Carregando vídeo: ${video}`);
        console.log(
          `Módulo: ${module}, Seção: ${section}, Índice do Vídeo: ${currentVideoIndex}`
        );

        if (video.endsWith(".mp4")) {
          // Carregar o vídeo
          videoPlayer.src = `/files/${encodedModule}/${encodedSection}/${encodedVideo}`;
          videoPlayer.style.display = "block";
          textContent.style.display = "none";
          document.getElementById("video-container").classList.remove("hidden");
          document.getElementById("download-link").classList.add("hidden");
          document.getElementById("user-notes").classList.remove("hidden");
          document.getElementById("save-notes").classList.remove("hidden");
          videoPlayer.play();
        } else if (video.endsWith(".txt")) {
          const downloadLink = document.getElementById("download-link");
          downloadLink.href = `/files/${encodedModule}/${encodedSection}/${encodedVideo}`;
          downloadLink.download = video; // Ensure the file is downloaded
          // Exibir conteúdo de texto
          const response = await fetch(
            `/files/${encodedModule}/${encodedSection}/${encodedVideo}`
          );
          const text = await response.text();
          textContent.innerHTML = `<div style="white-space: pre-wrap;">${text}</div>`;
          textContent.style.display = "block";
          videoPlayer.style.display = "none";
          document.getElementById("video-container").classList.remove("hidden");
          document.getElementById("download-link").classList.remove("hidden");
          document.getElementById("user-notes").classList.add("hidden");
          document.getElementById("save-notes").classList.add("hidden");

          // Adicionar botão de download estilizado junto ao botão "Salvar Notas"
          const downloadButton = document.createElement("a");
          downloadButton.href = `/files/${encodedModule}/${encodedSection}/${encodedVideo}`;
          downloadButton.download = video; // Ensure the file is downloaded
          downloadButton.classList.add(
            "px-4",
            "py-2",
            "bg-blue-500",
            "text-white",
            "rounded",
            "hover:bg-blue-700",
            "mt-2",
            "inline-block"
          );
          downloadButton.textContent = "Download";
          document
            .getElementById("video-container")
            .appendChild(downloadButton);
        } else if (video.endsWith(".zip")) {
          // Exibir modal de download
          const downloadLink = document.getElementById("download-link");
          downloadLink.href = `/files/${encodedModule}/${encodedSection}/${encodedVideo}`;
          document.getElementById("modal-title").textContent = `Download`;
          document.getElementById("download-link").classList.remove("hidden");
          document.getElementById(
            "modal-description"
          ).textContent = `Clique no botão abaixo para baixar o arquivo - "${video}".`;
          document.getElementById("video-container").classList.add("hidden");
          document.getElementById("download-modal").classList.remove("hidden");
          document.getElementById("download-modal").classList.add("fixed");

          // Adicionar evento para fechar o modal
          document
            .getElementById("close-modal")
            .addEventListener("click", () => {
              document.getElementById("download-modal").classList.add("hidden");
              document
                .getElementById("download-modal")
                .classList.remove("fixed");
            });

          // Limpar o vídeo atual
          videoPlayer.src = "";
        }

        // Atualiza título do vídeo
        document.getElementById("video-title").textContent = video;

        // Carregar notas do vídeo
        loadUserNotes(`${module}/${section}/${video}`);

        // Atualizar breadcrumbs
        document.getElementById(
          "breadcrumbs"
        ).textContent = `Módulo: ${module} > Seção: ${section} > Vídeo: ${video}`;

        // Armazenar a lista de vídeos e o índice do vídeo atual
        videoList = Object.values(data[module][section]); // Lista de vídeos da seção
        currentVideoIndex = videoList.indexOf(video); // Índice do vídeo atual

        updateNavigationButtons(); // Atualiza os botões de navegação
      }

      function updateNavigationButtons() {
        const nextButton = document.getElementById("next-button");
        const prevButton = document.getElementById("prev-button");

        if (currentVideoIndex >= videoList.length - 1) {
          // Último vídeo da seção, troca o botão "Próximo" por "Próxima Seção"
          nextButton.textContent = "Próxima Seção";
          nextButton.onclick = goToNextSection; // Chama a função para ir para a próxima seção
        } else {
          // Se não for o último vídeo, mantém a navegação normal
          nextButton.textContent = "Próximo";
          nextButton.onclick = () => {
            loadVideo(
              currentModule,
              currentSection,
              videoList[currentVideoIndex + 1]
            );
          };
        }

        // Desabilitar o botão "Anterior" se for o primeiro vídeo
        prevButton.disabled = currentVideoIndex <= 0;
      }

      // Função para navegar para a próxima seção
      function goToNextSection() {
        const sections = Object.keys(data[currentModule]);
        const currentSectionIndex = sections.indexOf(currentSection);

        if (currentSectionIndex < sections.length - 1) {
          // Se não for a última seção, carregar o primeiro vídeo da próxima seção
          const nextSection = sections[currentSectionIndex + 1];
          const firstVideo = data[currentModule][nextSection][0];
          loadVideo(currentModule, nextSection, firstVideo);
        } else {
          // Se for a última seção, ir para o próximo módulo
          goToNextModule();
        }
      }

      // Função para ir para o próximo módulo
      function goToNextModule() {
        const modules = Object.keys(data);
        const currentModuleIndex = modules.indexOf(currentModule);

        if (currentModuleIndex < modules.length - 1) {
          // Se não for o último módulo, carregar o primeiro vídeo do próximo módulo
          const nextModule = modules[currentModuleIndex + 1];
          const firstSection = Object.keys(data[nextModule])[0];
          const firstVideo = data[nextModule][firstSection][0];
          loadVideo(nextModule, firstSection, firstVideo);
        } else {
          alert("Você chegou ao final do curso!");
        }
      }

      document.getElementById("prev-button").addEventListener("click", () => {
        if (currentVideoIndex > 0) {
          loadVideo(
            currentModule,
            currentSection,
            videoList[currentVideoIndex - 1]
          );
        }
      });

      // Salvar notas do usuário
      document.getElementById("save-notes").addEventListener("click", () => {
        var notes = document.getElementById("user-notes").value;
        var currentVideo = document.getElementById("video-title").textContent;
        localStorage.setItem(currentVideo, notes);
        alert("Notas salvas com sucesso!");

        // Gerar arquivo .txt para download com prefixo do nome da aula, sem a extensão .mp4
        var videoName = currentVideo.replace(".mp4", "");
        console.log(videoName);
        var blob = new Blob([notes], { type: "text/plain" });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${videoName}-notas.txt`;
        link.click();
      });

      // Carregar notas salvas
      function loadUserNotes(path) {
        var notes = localStorage.getItem(path) || "";
        document.getElementById("user-notes").value = notes;
      }

      // Aumentar ou diminuir o tamanho da fonte
      document
        .getElementById("increase-font-size")
        .addEventListener("click", () => {
          document.body.style.fontSize = "1.4rem";
        });

      document
        .getElementById("decrease-font-size")
        .addEventListener("click", () => {
          document.body.style.fontSize = "1rem";
        });

      // Adicionar evento para fechar o modal
      document.getElementById("close-modal").addEventListener("click", () => {
        document.getElementById("download-modal").classList.add("hidden");
      });

      // Iniciar a carga de vídeos
      loadVideos();
    </script>
  </body>
</html>
